<div id="weatherBox" style="font-family:Arial, sans-serif; font-size:11px; max-width:300px; margin:auto; border-radius:10px; padding:10px; color:#222; background:#f9f9f9;">
  <div id="weatherContent">Loading weather...</div>
  <button id="changeLocBtn" style="margin-top:8px; font-size:11px; padding:4px 8px; border:none; border-radius:4px; background:#0d6efd; color:white; cursor:pointer;">Change Location</button>
</div>

<script>
const weatherContent = document.getElementById("weatherContent");
const changeLocBtn = document.getElementById("changeLocBtn");
const ICONS = {0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",51:"ğŸŒ¦ï¸",61:"ğŸŒ§ï¸",71:"â„ï¸",95:"â›ˆï¸"};

// Dark Mode
const darkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
document.getElementById("weatherBox").style.background = darkMode ? "#2c2c2c" : "#f9f9f9";
document.getElementById("weatherBox").style.color = darkMode ? "#f9f9f9" : "#222";

// Helper: Display weather
function displayWeather(current, forecast) {
  let forecastHTML = '';
  for (let i=1;i<=3;i++){
    forecastHTML += `<div style="flex:1; text-align:center; margin-top:3px;">
      <div><b>${new Date(forecast.time[i]).toLocaleDateString("en-US",{weekday:"short"})}</b></div>
      <div>${ICONS[forecast.weather_code[i]]||"â›…"}</div>
      <div>${forecast.temperature_2m_max[i]}Â° / ${forecast.temperature_2m_min[i]}Â°</div>
    </div>`;
  }

  weatherContent.innerHTML = `
    <div style="text-align:center;">
      <div><b>${current.temperature}Â°C</b></div>
      <div style="font-size:24px;">${ICONS[current.weathercode]||"â›…"}</div>
      <div style="display:flex; justify-content:space-between;">${forecastHTML}</div>
    </div>
  `;
}

// Fetch weather from Open-Meteo
async function loadWeather(lat, lon) {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;
    const data = await fetch(url).then(r=>r.json());
    localStorage.setItem("weatherLat", lat);
    localStorage.setItem("weatherLon", lon);
    displayWeather(data.current_weather, data.daily);
  } catch {
    weatherContent.innerHTML = "Unable to load weather.";
  }
}

// Manual location
async function manualSearch() {
  const city = prompt("Enter city name:");
  if(!city) return;
  weatherContent.innerHTML = "Searching location...";
  try {
    const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1`).then(r=>r.json());
    if(!geo.results?.length) { weatherContent.innerHTML="Location not found"; return; }
    loadWeather(geo.results[0].latitude, geo.results[0].longitude);
  } catch {
    weatherContent.innerHTML="Error finding location";
  }
}

// Init
async function startWeather() {
  const savedLat = localStorage.getItem("weatherLat");
  const savedLon = localStorage.getItem("weatherLon");
  if(savedLat && savedLon){
    loadWeather(savedLat,savedLon);
  } else {
    navigator.geolocation.getCurrentPosition(
      pos => loadWeather(pos.coords.latitude,pos.coords.longitude),
      () => manualSearch(),
      {timeout:3000}
    );
  }
}

// Change location button
changeLocBtn.onclick = manualSearch;

// Auto-refresh every 10 min
setInterval(() => {
  const savedLat = localStorage.getItem("weatherLat");
  const savedLon = localStorage.getItem("weatherLon");
  if(savedLat && savedLon) loadWeather(savedLat,savedLon);
}, 600000);

// Start widget
startWeather();
</script>
