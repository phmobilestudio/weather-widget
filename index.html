<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weather Widget</title>

<link rel="preconnect" href="https://api.open-meteo.com">
<link rel="preconnect" href="https://ipinfo.io">

<style>
  body {
    margin: 0;
    background: transparent;
    font-family: Arial, sans-serif;
    font-size: 11px;
    color: #222;
  }
  .weather-box {
    width: 100%;
    max-width: 280px;
    margin: auto;
    text-align: center;
  }
  .temp {
    font-size: 20px;
    font-weight: bold;
  }
  .big-icon {
    font-size: 26px;
    margin: 4px 0;
  }
  .forecast {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
  }
  .day { flex: 1; }
  .day div { margin-bottom: 2px; }

  /* Manual location UI */
  #manualBox {
    margin-top: 8px;
    display: none;
  }
  #locationInput {
    width: 90%;
    padding: 4px;
    font-size: 11px;
  }
  .btn {
    margin-top: 5px;
    background: #0d6efd;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    border: none;
  }
</style>
</head>

<body>
<div class="weather-box">
  <div id="loc">Loadingâ€¦</div>
  <div class="temp" id="temp">--Â°C</div>
  <div class="big-icon" id="icon">â›…</div>
  <div class="forecast" id="forecast"></div>

  <button class="btn" onclick="toggleManual()">Change Location</button>

  <div id="manualBox">
    <input id="locationInput" placeholder="Enter city (e.g. Manila)" />
    <button class="btn" onclick="manualSearch()">OK</button>
  </div>
</div>

<script defer>
const icons={
  0:"â˜€ï¸",1:"ðŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ðŸŒ«ï¸",
  48:"ðŸŒ«ï¸",51:"ðŸŒ¦ï¸",61:"ðŸŒ§ï¸",71:"â„ï¸",95:"â›ˆï¸"
};

async function loadWeather(lat, lon, placeName="Your Location") {
  document.getElementById("loc").textContent = placeName;

  const w = await fetch(
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
    `&current=temperature_2m,weather_code`+
    `&daily=weather_code,temperature_2m_max,temperature_2m_min`+
    `&timezone=auto`
  ).then(r=>r.json());

  document.getElementById("temp").textContent = w.current.temperature_2m+"Â°C";
  document.getElementById("icon").textContent = icons[w.current.weather_code] || "â›…";

  let out="";
  for(let i=1;i<=3;i++){
    out += `
      <div class="day">
        <div><b>${new Date(w.daily.time[i]).toLocaleDateString("en-US",{weekday:"short"})}</b></div>
        <div>${icons[w.daily.weather_code[i]] || "â›…"}</div>
        <div>${w.daily.temperature_2m_max[i]}Â° / ${w.daily.temperature_2m_min[i]}Â°</div>
      </div>`;
  }
  document.getElementById("forecast").innerHTML = out;
}

// AUTO-LOCATION (default)
(async()=>{
  try {
    const geo = await fetch("https://ipinfo.io/json?token=fa7e3a51cbea66").then(r=>r.json());
    const [lat, lon] = geo.loc.split(",");
    loadWeather(lat, lon, geo.city);
  } catch {
    document.getElementById("loc").textContent = "Location unavailable";
  }
})();

// UI toggle
function toggleManual(){
  const box = document.getElementById("manualBox");
  box.style.display = box.style.display === "block" ? "none" : "block";
}

// Manual location search
async function manualSearch(){
  const city = document.getElementById("locationInput").value;
  if(!city) return;

  // Use Open-Meteo geocoding (free & fast)
  const data = await fetch(
    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1`
  ).then(r=>r.json());

  if(!data.results || data.results.length === 0){
    document.getElementById("loc").textContent = "City not found";
    return;
  }

  const result = data.results[0];
  loadWeather(result.latitude, result.longitude, result.name);
}
</script>

</body>
</html>
